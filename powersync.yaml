# PowerSync Service Configuration for Stride Desktop
# Local development configuration

# Opt out of anonymous telemetry
telemetry:
  disable_telemetry_sharing: true

# Source database replication settings
replication:
  connections:
    - type: postgresql
      uri: !env PS_DATABASE_URL
      sslmode: disable

# Bucket storage database configuration
# Using the same Postgres instance for bucket storage (requires Postgres 14+)
storage:
  type: postgresql
  uri: !env PS_DATABASE_URL
  sslmode: disable

# API server port
port: 8080

# Synchronization rules
sync_rules:
  content: |
    bucket_definitions:
      # User-specific bucket - each user gets their own data
      user_data:
        parameters: SELECT request.user_id() as user_id
        data:
          - SELECT * FROM users WHERE id = bucket.user_id
          - SELECT * FROM workspaces WHERE owner_user_id = bucket.user_id
          - SELECT * FROM workspace_members WHERE user_id = bucket.user_id
          - SELECT * FROM projects WHERE user_id = bucket.user_id
          - SELECT * FROM tasks WHERE user_id = bucket.user_id
          - SELECT * FROM task_types WHERE user_id = bucket.user_id
          - SELECT * FROM time_entries WHERE user_id = bucket.user_id
          - SELECT * FROM daily_summaries WHERE user_id = bucket.user_id
          - SELECT * FROM user_preferences WHERE user_id = bucket.user_id
          - SELECT * FROM user_subscriptions WHERE user_id = bucket.user_id

      # Global bucket - shared read-only data (synced to all users)
      global:
        data:
          - SELECT * FROM roles

# Client authentication configuration
client_auth:
  # Using Supabase JWT authentication
  supabase: true
  jwks_uri: http://host.docker.internal:54321/auth/v1/jwks
  audience: ['authenticated']

# System-level settings
system:
  logging:
    level: debug
    format: json
